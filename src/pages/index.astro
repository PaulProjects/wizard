---
import Layout from "../layouts/Layout.astro";
import { Icon } from "astro-icon/components";
import Lightning from "../components/Lightning.astro";
import ImportGame from "../components/ImportGame.astro";
---

<Layout title="Wizard Scorekeeper App!">
  <div class="wrapper flex justify-center items-center w-screen h-screen pb-10">
    <div class="box w-full p-5 md:w-1/2 lg:h-1/2 lg:mt-10">
      <main>
        <div class="h-80 flex items-center justify-center">
          <img
            class="mt-0 w-full h-full lg:w-4/5"
            src="/witch.svg"
            alt="logo"
          />
        </div>
        <h1 class="text-center h-28 text-9xl">Wizard</h1>
        <h2 class="text-center text-2xl" id="loading">Loading...</h2>
        <nav class="boxbuttons mt-10">
          <button class="btn btn-secondary mb-2 btn-block" id="new_game"
            ><a href="/setup"><span id="new_game_text">New game</span></a
            ></button
          >
          <button class="btn btn-neutral mb-2 btn-block" id="resume_game"
            ><a href="/game"><span>Resume game</span></a></button
          >
          <button class="btn btn-neutral mb-10 btn-block" id="past_games"
            ><a href="/history"><span>Past games</span></a></button
          >
        </nav>
      </main>
    </div>
  </div>

  <div class="credits float-left pl-4">
    <div class="flex flex-row w-1/2">
      <a
        href="https://github.com/PaulProjects/wizard"
        class="w-full"
        aria-label="Github"
        title="Github"
        target="_blank"
      >
        <Icon name="mdi:github" class="w-8 h-8" /></a
      >
      <button
        class="w-full"
        onclick="
        about.showModal()
        "
        id="buttonAbout"
        title="Open About Modal"><Icon name="mdi:help-circle-outline" class="w-8 h-8" /></button
      >
    </div>
  </div>
  <div class="legal float-right">
    <a class="underline pr-2" href="https://paulbertram.de/impressum/">Impressum</a>
    <a class="underline" href="https://paulbertram.de/datenschutz/">Datenschutz</a>
  </div>
  <!-- About Modal -->
  <dialog id="about" class="modal">
    <form method="dialog" class="modal-box max-w-2xl">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
        >✕</button
      >
      
      <!-- Header -->
      <div class="flex items-center gap-3 mb-6">
        <Icon name="mdi:information-outline" class="w-8 h-8 text-primary" />
        <h1 class="font-bold text-3xl">About Wizard</h1>
      </div>

      <!-- About Section -->
      <div class="space-y-6">
        <div class="p-4 bg-base-200 rounded-lg">
          <div class="flex items-start gap-3 mb-3">
            <Icon name="mdi:gamepad-variant-outline" class="w-6 h-6 text-primary flex-shrink-0 mt-1" />
            <div>
              <h2 class="font-semibold text-lg mb-2">What is this?</h2>
              <p class="text-base-content/80 leading-relaxed">
                This is a digital score counter for the popular card game Wizard. 
                Track scores, analyze performance, and never lose track of your game progress again.
              </p>
            </div>
          </div>
        </div>

        <!-- Development Status -->
        <div class="p-4 bg-primary/5 border border-primary/20 rounded-lg">
          <div class="flex items-start gap-3">
            <Icon name="mdi:hammer-wrench" class="w-6 h-6 text-primary flex-shrink-0 mt-1" />
            <div>
              <h2 class="font-semibold text-lg mb-2">Development</h2>
              <p class="text-base-content/80 leading-relaxed mb-3">
                This project is actively being developed with new features added regularly. 
                Have suggestions or feedback?
              </p>
              <a
                class="btn btn-sm btn-secondary"
                href="mailto:hi@paulbertram.de"
              >
                <Icon name="mdi:email-outline" class="w-4 h-4 mr-2" />
                Contact Developer
              </a>
            </div>
          </div>
        </div>

        <!-- Credits Section -->
        <div class="p-4 bg-base-200 rounded-lg">
          <div class="flex items-start gap-3 mb-3">
            <Icon name="mdi:account-heart-outline" class="w-6 h-6 text-secondary flex-shrink-0 mt-1" />
            <div class="w-full">
              <h2 class="font-semibold text-lg mb-3">Credits & Inspiration</h2>
              <div class="space-y-2">
                <a
                  class="flex items-center gap-2 p-2 bg-base-100 rounded hover:bg-base-300 transition-colors"
                  href="https://codepen.io/jackrugile/pen/kQwPRO"
                  target="_blank"
                >
                  <Icon name="mdi:lightning-bolt" class="w-4 h-4" />
                  Lightning Background Effect
                  <Icon name="mdi:open-in-new" class="w-3 h-3 ml-auto opacity-60" />
                </a>
                <a
                  class="flex items-center gap-2 p-2 bg-base-100 rounded hover:bg-base-300 transition-colors"
                  href="https://codepen.io/jmolund/pen/jBqyqK"
                  target="_blank"
                >
                  <Icon name="mdi:view-dashboard-outline" class="w-4 h-4" />
                  ScoreBoard Design
                  <Icon name="mdi:open-in-new" class="w-3 h-3 ml-auto opacity-60" />
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Legal Disclaimer -->
        <div class="p-4 bg-warning/10 border border-warning/30 rounded-lg">
          <div class="flex items-start gap-3">
            <Icon name="mdi:scale-balance" class="w-6 h-6 text-warning flex-shrink-0 mt-1" />
            <div>
              <h2 class="font-semibold text-lg mb-2">Legal Notice</h2>
              <p class="text-sm text-base-content/70 leading-relaxed">
                This application is not affiliated with Amigo Spiele or any other company. 
                Wizard® is a registered trademark of Amigo Spiele. This tool is designed 
                for personal, non-commercial use only.
              </p>
            </div>
          </div>
        </div>

        <!-- Data Management -->
        <div class="p-4 bg-base-200 rounded-lg">
          <div class="flex items-start gap-3 mb-4">
            <Icon name="mdi:database-outline" class="w-6 h-6 text-accent flex-shrink-0 mt-1" />
            <div>
              <h2 class="font-semibold text-lg mb-2">Data Management</h2>
              <p class="text-base-content/80 text-sm mb-4">
                Manage your game data
              </p>
            </div>
          </div>
          
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <button class="btn btn-outline btn-sm import_data">
              <Icon name="mdi:import" class="w-4 h-4" />
              Import
            </button>
            <button id="export_data" class="btn btn-outline btn-sm">
              <Icon name="mdi:export" class="w-4 h-4" />
              Export
            </button>
            <button id="delete_data" class="btn btn-error btn-outline btn-sm">
              <Icon name="mdi:delete-outline" class="w-4 h-4" />
              Delete All
            </button>
          </div>
        </div>
      </div>
    </form>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
  <!-- Really delete all data Modal -->
  <dialog id="alert_delete" class="modal">
    <form method="dialog" class="modal-box">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
        >✕</button
      >
      <h1 class="font-bold text-lg">Really delete all data?</h1>
      <p class="py-4">
        This will delete all data stored in your browser. This includes the
        current game and all past games. You can't undo this action.
      </p>
      <button id="del_data" class="btn btn-warning btn-block mt-4"
        >Delete all Data</button
      >
      <button class="btn btn-info btn-block mt-2"> Cancel</button>
    </form>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
  <ImportGame />
  <Lightning />
  <style>
    .boxbuttons {
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .credits {
      width: 150px;
      height: 50px;
    }

    .legal {
      width: 200px;
      height: 50px;
    }
  </style>
  <script>
    import { gamedata } from "../scripts/game/gamedata";

    //* Function to validate game data stored in local storage */
    function validateGame(): boolean {
      if (!localStorage.getItem("game")) {
        return false;
      }

      try {
        gamedata.fromJSONString(localStorage.getItem("game"));
      } catch (error) {
        console.log("Error validating game data: " + error);
        return false;
      }
      return true;
    }

    document.onreadystatechange = function () {
      //hide loading text when page is loaded
      if (document.readyState === "complete") {
        document.getElementById("loading").classList.add("hidden");
      }

      //hide past games button if no past games are stored
      if (!localStorage.getItem("recent_games")) {
        document.getElementById("past_games").classList.add("hidden");
      }

      //hide resume game button if no valid game is stored
      if (!validateGame()) {
        document.getElementById("resume_game").classList.add("hidden");
      }

      //hide export data button if there is nothing to export
      if (
        !localStorage.getItem("game") &&
        !localStorage.getItem("recent_games") &&
        !localStorage.getItem("playerlist")
      ) {
        document.getElementById("export_data").classList.add("hidden");
      }
    };

    //loading indicator when new game is clicked
    document.getElementById("new_game").addEventListener("click", function () {
      location.href = "/setup";
      document.getElementById("new_game_text").innerHTML = `Loading...`;
    });

    document
      .getElementById("delete_data")
      .addEventListener("click", function () {
        (
          document.getElementById("alert_delete") as HTMLDialogElement
        ).showModal();
      });

    document.getElementById("del_data").addEventListener("click", function () {
      localStorage.clear();
      location.reload();
    });
  </script>
</Layout>
