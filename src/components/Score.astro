---
import { Icon } from "astro-icon/components";
import Celebration from "./Celebration.astro";
---

<div class="wrapper flex justify-center items-center w-screen h-full">
	<div
		class="flex items-center justify-center flex-col p-3 md:p-5 w-full lg:h-2/3"
	>
		<div class="w-full lg:w-2/3">
			<div class="sticky top-0 bg-base-100 z-50 mb-4">
				<div
					class="flex items-center justify-between gap-2 min-h-[3rem]"
				>
					<!-- Left: Round and Bet Display -->
					<div class="flex items-center gap-3 flex-shrink-0">
						<h2 class="text-2xl font-bold" id="s_round">
							Loading...
						</h2>
						<div id="bet_display_container" class="hidden">
							<div class="flex items-center gap-2">
								<div
									id="bet_above"
									class="flex flex-col items-center justify-center bg-base-200 rounded-lg p-2 min-w-[2.5rem]"
								>
									<span
										class="text-xs font-medium"
										id="bet_above_text">3</span
									>
									<Icon
										name="mdi:chevron-up"
										class="w-4 h-4"
									/>
								</div>
								<div
									id="bet_below"
									class="flex flex-col items-center justify-center bg-base-200 rounded-lg p-2 min-w-[2.5rem]"
								>
									<Icon
										name="mdi:chevron-down"
										class="w-4 h-4"
									/>
									<span
										class="text-xs font-medium"
										id="bet_below_text">3</span
									>
								</div>
							</div>
						</div>
					</div>

					<!-- Center: Tab Navigation - Flexible -->
					<div class="flex justify-center flex-1 px-2">
						<div
							id="tab_navigation"
							class="bg-base-200 rounded-lg flex gap-1 sm:gap-1 p-1 sm:p-1 max-w-none w-full sm:w-auto"
						>
							<button
								class="tab-btn flex items-center justify-center px-2 sm:px-3 py-2 rounded-md transition-colors flex-1 sm:flex-initial min-w-[2.25rem] sm:min-w-[2.5rem] h-10 hidden"
								id="tab_celeb"
								data-tab="celebration"
							>
								<Icon
									name="mdi:trophy-variant"
									class="w-5 h-5 flex-shrink-0"
								/>
								<span
									class="tab-label text-sm pl-2 whitespace-nowrap"
									>Winner</span
								>
							</button>
							<button
								class="tab-btn flex items-center justify-center px-2 sm:px-3 py-2 rounded-md transition-colors flex-1 sm:flex-initial min-w-[2.25rem] sm:min-w-[2.5rem] h-10"
								id="tab_top"
								data-tab="top_players"
							>
								<Icon
									name="mdi:format-list-numbered"
									class="w-5 h-5 flex-shrink-0"
								/>
								<span
									class="tab-label text-sm pl-2 whitespace-nowrap"
									>Overview</span
								>
							</button>

							<button
								class="tab-btn flex items-center justify-center px-2 sm:px-3 py-2 rounded-md transition-colors flex-1 sm:flex-initial min-w-[2.25rem] sm:min-w-[2.5rem] h-10"
								id="tab_chart"
								data-tab="graph"
							>
								<Icon
									name="mdi:chart-timeline-variant"
									class="w-5 h-5 flex-shrink-0"
								/>
								<span
									class="tab-label text-sm pl-2 whitespace-nowrap"
									>Chart</span
								>
							</button>
							<button
								class="tab-btn flex items-center justify-center px-2 sm:px-3 py-2 rounded-md transition-colors flex-1 sm:flex-initial min-w-[2.25rem] sm:min-w-[2.5rem] h-10"
								id="tab_analytics"
								data-tab="analytics"
							>
								<Icon
									name="mdi:magnify-scan"
									class="w-5 h-5 flex-shrink-0"
								/>
								<span
									class="tab-label text-sm pl-2 whitespace-nowrap"
									>Analytics</span
								>
							</button>
						</div>
					</div>

					<!-- Right: Settings Button -->
					<div class="flex justify-end flex-shrink-0">
						<button
							class="btn h-10 px-3"
							onclick="modal_settings.showModal(); try { window.wizardLogger && window.wizardLogger.event && window.wizardLogger.event('settings.open'); } catch (e) {}"
						>
							<Icon name="mdi:cog" class="w-5 h-5" />
						</button>
					</div>
				</div>
			</div>

			<!-- Tab Content Panels -->
			<div class="tab-content-container">
				<!-- Celebration Tab -->
				<div class="tab-panel hidden" id="celebration">
					<Celebration />
				</div>

				<!-- Top Players Tab -->
				<div class="tab-panel hidden" id="top_players">
					<div
						class="flex flex-row flex-wrap items-start justify-center w-full gap-4"
					>
						<!-- Top players content will be populated by JavaScript -->
					</div>
				</div>

				<!-- Chart Tab -->
				<div class="tab-panel hidden" id="graph" style="height: 80svh;">
					<div class="h-full w-full" id="chart_container">
						<canvas id="chart"></canvas>
					</div>
				</div>

				<!-- Analytics Tab -->
				<div class="tab-panel hidden" id="analytics">
					<div class="grid grid-cols-1 md:grid-cols-2 gap-5">
						<div class="stats bg-secondary text-primary-content">
							<div class="stat">
								<div class="stat-title text-primary-content">
									Best Round
								</div>
								<div class="stat-value" id="best_bet_name">
									Jakob
								</div>
								<div
									class="stat-desc text-primary-content"
									id="best_bet_desc"
								>
									Runde 10
								</div>
							</div>
						</div>
						<div class="stats bg-secondary text-primary-content">
							<div class="stat">
								<div class="stat-title text-primary-content">
									Worst Round
								</div>
								<div class="stat-value" id="worst_bet_name">
									Jakob
								</div>
								<div
									class="stat-desc text-primary-content"
									id="worst_bet_desc"
								>
									Runde 10
								</div>
							</div>
						</div>
					</div>
					<div id="player_stats"></div>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="pb-20"></div>
<!-- Info modal -->
<dialog id="modal_info" class="modal modal-top sm:modal-middle">
	<form method="dialog" class="modal-box max-w-2xl">
		<button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
			>✕</button
		>
		<div class="flex flex-col justify-center items-center">
			<div class="flex items-center gap-3 mb-6">
				<Icon name="mdi:information-outline" class="w-8 h-8 text-primary" />
				<h2 class="font-bold text-3xl">Score Page Guide</h2>
			</div>
			
			<div class="w-full max-w-lg">
				<p class="text-center text-base-content/80 mb-6">
					The Score Page offers multiple ways to analyze game performance. 
					Switch between different views using the tabs below.
				</p>

				<!-- Tab Explanations -->
				<div class="space-y-4">
					<!-- Overview Tab -->
					<div class="flex items-start gap-4 p-4 bg-base-200 rounded-lg">
						<div class="flex-shrink-0 w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
							<Icon name="mdi:format-list-numbered" class="w-6 h-6 text-primary" />
						</div>
						<div class="flex-1">
							<h3 class="font-semibold text-lg mb-1">Overview</h3>
							<p class="text-sm text-base-content/70">
								View all players ranked by their current scores. Click on any player card to see detailed statistics.
							</p>
						</div>
					</div>

					<!-- Chart Tab -->
					<div class="flex items-start gap-4 p-4 bg-base-200 rounded-lg">
						<div class="flex-shrink-0 w-12 h-12 bg-secondary/10 rounded-lg flex items-center justify-center">
							<Icon name="mdi:chart-timeline-variant" class="w-6 h-6 text-secondary" />
						</div>
						<div class="flex-1">
							<h3 class="font-semibold text-lg mb-1">Score Chart</h3>
							<p class="text-sm text-base-content/70 mb-2">
								Track score progression throughout the game with an interactive line chart.
							</p>
						</div>
					</div>

					<!-- Analytics Tab -->
					<div class="flex items-start gap-4 p-4 bg-base-200 rounded-lg">
						<div class="flex-shrink-0 w-12 h-12 bg-accent/10 rounded-lg flex items-center justify-center">
							<Icon name="mdi:magnify-scan" class="w-6 h-6 text-accent" />
						</div>
						<div class="flex-1">
							<h3 class="font-semibold text-lg mb-1">Game Analytics</h3>
							<p class="text-sm text-base-content/70">
								Deep dive into game statistics including best/worst rounds and individual player performance metrics.
							</p>
						</div>
					</div>
				</div>

				<!-- Additional Tips -->
				<div class="mt-6 p-4 bg-primary/5 border border-primary/20 rounded-lg">
					<h4 class="font-medium text-sm mb-2 flex items-center gap-2">
						<Icon name="mdi:lightbulb-outline" class="w-4 h-4" />
						Tips
					</h4>
					<ul class="text-xs text-base-content/70 space-y-1">
						<li>• The <span class="badge badge-secondary badge-xs">blue highlight</span> indicates the current dealer</li>
						<li>• Tap player cards in Overview to see detailed stats</li>
						<li>• The Chart and Analytics tabs are Available after the second round</li>
						<li>• Chart view works best in landscape mode</li>
						<li>• The bet indicators to see over/under predictions</li>
					</ul>
				</div>
			</div>
		</div>
	</form>
	<form method="dialog" class="modal-backdrop">
		<button>close</button>
	</form>
</dialog>

<!-- Player Stats Modal -->
<dialog id="modal_player_stats" class="modal modal-bottom sm:modal-middle">
	<form id="modal_player_stats_form" method="dialog" class="modal-box">
		<button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
			>✕</button
		>

		{
			Astro.url.pathname === "/game/" && (
				<button
					class="btn btn-circle btn-ghost absolute left-2 top-2"
					id="edit_player_button"
					title="Edit Player Data"
				>
					<Icon name="mdi:pencil" class="w-5 h-5" />
				</button>
			)
		}

		<div class="flex flex-col items-center mb-6">
			<h2 class="font-bold text-3xl mt-2" id="modal_player_name">
				Player Name
			</h2>
		</div>

		<!-- Player Summary Stats -->
		<div
			class="modal_player_stat grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"
		>
			<div class="stat bg-base-200 rounded-lg p-4 text-center">
				<div class="stat-title">Total Score</div>
				<div class="stat-value text-primary" id="modal_total_score">
					0
				</div>
			</div>
			<div class="stat bg-base-200 rounded-lg p-4 text-center">
				<div class="stat-title">Bet Accuracy</div>
				<div class="stat-value text-secondary" id="modal_bet_accuracy">
					0%
				</div>
			</div>
			<div class="stat bg-base-200 rounded-lg p-4 text-center">
				<div class="stat-title">Average Bet</div>
				<div class="stat-value" id="modal_avg_bet">0</div>
			</div>
		</div>

		<!-- Round by Round Performance -->
		<div class="mb-4">
			<h3 class="text-xl font-semibold mb-3">Round Performance</h3>
			<div class="overflow-x-auto">
				<table class="table table-zebra w-full">
					<thead>
						<tr>
							<th>Round</th>
							<th>Bet</th>
							<th>Tricks</th>
							<th>Points</th>
						</tr>
					</thead>
					<tbody id="modal_rounds_table">
						<!-- Round data will be populated by JavaScript -->
					</tbody>
				</table>
			</div>
		</div>


	</form>
	<form method="dialog" class="modal-backdrop">
		<button>close</button>
	</form>
</dialog>

<!-- Edit Player Modal -->
<dialog id="modal_edit_player" class="modal modal-bottom sm:modal-middle">
	<form
		id="modal_edit_player_form"
		method="dialog"
		class="modal-box max-w-4xl"
	>
		<button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
			>✕</button
		>

		<div class="flex flex-col items-center mb-6">
			<h2 class="font-bold text-3xl mt-2">Edit Player Data</h2>
			<div
				class="badge badge-secondary text-lg px-4 py-2 mt-2"
				id="edit_player_name_display"
			>
				Player Name
			</div>
		</div>

		<!-- Player Name Input -->
		<div class="mb-6">
			<label class="form-control w-full">
				<h3 class="text-xl font-semibold mb-3">Name</h3>
				<input
					type="text"
					class="input input-bordered w-full"
					id="edit_player_name_input"
					placeholder="Enter player name"
				/>
			</label>
		</div>

		<!-- Round by Round Edits -->
		<div class="mb-6">
			<h3 class="text-xl font-semibold mb-3">Rounds</h3>
			<div class="overflow-x-auto max-h-80 overflow-y-auto">
				<table class="table table-zebra w-full">
					<thead>
						<tr>
							<th>Round</th>
							<th>Bet</th>
							<th>Tricks</th>
							<th class="text-center">Score Change</th>
						</tr>
					</thead>
					<tbody id="edit_rounds_table">
						<!-- Round data will be populated by JavaScript -->
					</tbody>
				</table>
			</div>
		</div>

		<!-- Save/Cancel Buttons -->
		<div class="flex gap-4 justify-end w-full">
			<button
				class="btn btn-neutral flex-1"
				type="button"
				id="edit_player_cancel"
			>
				Cancel
			</button>
			<button
				class="btn btn-secondary flex-1"
				type="button"
				id="edit_player_save"
			>
				Save Changes
			</button>
		</div>
	</form>
	<form method="dialog" class="modal-backdrop">
		<button>close</button>
	</form>
</dialog>

<dialog>
	<!-- ToDo: Überdenken ob das wirklich die beste lösung ist -->
	<div class="stats-vertical sm:stats-horizontal mx-auto w-60"></div>
</dialog>
<!-- End of modal -->
<!-- End of content -->

<style>
	td {
		overflow: hidden;
		text-overflow: ellipsis;
		word-wrap: break-word;
	}
	.tcontainer {
		overflow-x: auto;
		white-space: nowrap;
	}

	@media screen and (max-width: 600px) {
		.chart_content {
			width: 90vw;
			height: 90vh;
		}
	}

	/* Custom tab styling */
	.tab-btn {
		color: hsl(var(--bc) / 0.6);
		background-color: transparent;
		border: none;
		cursor: pointer;
		flex-shrink: 0;
	}

	.tab-btn:hover {
		color: hsl(var(--bc));
		background-color: hsl(var(--p) / 0.1);
		box-shadow: 0 2px 8px 0 rgb(0 0 0 / 0.15);
	}

	.tab-btn.active {
		@apply bg-white text-neutral;
	}

	/* Touch-friendly tab content for swipe gestures */
	.tab-content-container {
		touch-action: pan-y; /* Allow vertical scrolling but handle horizontal swipes */
		user-select: none; /* Prevent text selection during swipes */
		transition: opacity 0.1s ease-in-out; /* Smooth opacity transition for swipe feedback */
	}

	/* Player card interaction styles */
	.top-player-card {
		cursor: pointer;
		transition: all 0.3s ease;
	}

	.top-player-card:hover {
		transform: translateY(-8px);
		box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
	}

	.top-player-card:active {
		transform: translateY(-4px);
	}

	/* Tab label visibility and responsive adjustments are handled by Tailwind classes */
	@media screen and (max-width: 640px) {
		/* Hide tab labels on mobile */
		.tab-label {
			display: none;
		}
	}
</style>
